import{A as e,B as t,C as n,D as r,E as i,F as a,G as o,H as s,I as c,J as l,M as u,O as d,t as f,u as p,v as m,w as h,x as g,y as _,z as v}from"./index-BhFOQNBT.js";var y=class extends l{constructor(e,t){super(),this.options=t,this.#client=e,this.#selectError=null,this.#currentThenable=g(),this.bindMethods(),this.setOptions(t)}#client;#currentQuery=void 0;#currentQueryInitialState=void 0;#currentResult=void 0;#currentResultState;#currentResultOptions;#currentThenable;#selectError;#selectFn;#selectResult;#lastQueryWithDefinedData;#staleTimeoutId;#refetchIntervalId;#currentRefetchInterval;#trackedProps=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.#currentQuery.addObserver(this),x(this.#currentQuery,this.options)?this.#executeFetch():this.updateResult(),this.#updateTimers())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return S(this.#currentQuery,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return S(this.#currentQuery,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#clearStaleTimeout(),this.#clearRefetchInterval(),this.#currentQuery.removeObserver(this)}setOptions(e){let t=this.options,n=this.#currentQuery;if(this.options=this.#client.defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!=`boolean`&&typeof this.options.enabled!=`function`&&typeof r(this.options.enabled,this.#currentQuery)!=`boolean`)throw Error(`Expected enabled to be a boolean or a callback that returns a boolean`);this.#updateQuery(),this.#currentQuery.setOptions(this.options),t._defaulted&&!a(this.options,t)&&this.#client.getQueryCache().notify({type:`observerOptionsUpdated`,query:this.#currentQuery,observer:this});let o=this.hasListeners();o&&C(this.#currentQuery,n,this.options,t)&&this.#executeFetch(),this.updateResult(),o&&(this.#currentQuery!==n||r(this.options.enabled,this.#currentQuery)!==r(t.enabled,this.#currentQuery)||i(this.options.staleTime,this.#currentQuery)!==i(t.staleTime,this.#currentQuery))&&this.#updateStaleTimeout();let s=this.#computeRefetchInterval();o&&(this.#currentQuery!==n||r(this.options.enabled,this.#currentQuery)!==r(t.enabled,this.#currentQuery)||s!==this.#currentRefetchInterval)&&this.#updateRefetchInterval(s)}getOptimisticResult(e){let t=this.#client.getQueryCache().build(this.#client,e),n=this.createResult(t,e);return T(this,n)&&(this.#currentResult=n,this.#currentResultOptions=this.options,this.#currentResultState=this.#currentQuery.state),n}getCurrentResult(){return this.#currentResult}trackResult(e,t){return new Proxy(e,{get:(e,n)=>(this.trackProp(n),t?.(n),n===`promise`&&(this.trackProp(`data`),!this.options.experimental_prefetchInRender&&this.#currentThenable.status===`pending`&&this.#currentThenable.reject(Error(`experimental_prefetchInRender feature flag is not enabled`))),Reflect.get(e,n))})}trackProp(e){this.#trackedProps.add(e)}getCurrentQuery(){return this.#currentQuery}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){let t=this.#client.defaultQueryOptions(e),n=this.#client.getQueryCache().build(this.#client,t);return n.fetch().then(()=>this.createResult(n,t))}fetch(e){return this.#executeFetch({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#currentResult))}#executeFetch(e){this.#updateQuery();let n=this.#currentQuery.fetch(this.options,e);return e?.throwOnError||(n=n.catch(t)),n}#updateStaleTimeout(){this.#clearStaleTimeout();let t=i(this.options.staleTime,this.#currentQuery);if(v||this.#currentResult.isStale||!e(t))return;let n=s(this.#currentResult.dataUpdatedAt,t),r=n+1;this.#staleTimeoutId=c.setTimeout(()=>{this.#currentResult.isStale||this.updateResult()},r)}#computeRefetchInterval(){return(typeof this.options.refetchInterval==`function`?this.options.refetchInterval(this.#currentQuery):this.options.refetchInterval)??!1}#updateRefetchInterval(t){this.#clearRefetchInterval(),this.#currentRefetchInterval=t,!(v||r(this.options.enabled,this.#currentQuery)===!1||!e(this.#currentRefetchInterval)||this.#currentRefetchInterval===0)&&(this.#refetchIntervalId=c.setInterval(()=>{(this.options.refetchIntervalInBackground||_.isFocused())&&this.#executeFetch()},this.#currentRefetchInterval))}#updateTimers(){this.#updateStaleTimeout(),this.#updateRefetchInterval(this.#computeRefetchInterval())}#clearStaleTimeout(){this.#staleTimeoutId&&=(c.clearTimeout(this.#staleTimeoutId),void 0)}#clearRefetchInterval(){this.#refetchIntervalId&&=(c.clearInterval(this.#refetchIntervalId),void 0)}createResult(e,t){let i=this.#currentQuery,a=this.options,o=this.#currentResult,s=this.#currentResultState,c=this.#currentResultOptions,l=e!==i,u=l?e.state:this.#currentQueryInitialState,{state:d}=e,f={...d},p=!1,h;if(t._optimisticResults){let n=this.hasListeners(),r=!n&&x(e,t),o=n&&C(e,i,t,a);(r||o)&&(f={...f,...m(d.data,e.options)}),t._optimisticResults===`isRestoring`&&(f.fetchStatus=`idle`)}let{error:_,errorUpdatedAt:v,status:y}=f;h=f.data;let b=!1;if(t.placeholderData!==void 0&&h===void 0&&y===`pending`){let e;o?.isPlaceholderData&&t.placeholderData===c?.placeholderData?(e=o.data,b=!0):e=typeof t.placeholderData==`function`?t.placeholderData(this.#lastQueryWithDefinedData?.state.data,this.#lastQueryWithDefinedData):t.placeholderData,e!==void 0&&(y=`success`,h=n(o?.data,e,t),p=!0)}if(t.select&&h!==void 0&&!b)if(o&&h===s?.data&&t.select===this.#selectFn)h=this.#selectResult;else try{this.#selectFn=t.select,h=t.select(h),h=n(o?.data,h,t),this.#selectResult=h,this.#selectError=null}catch(e){this.#selectError=e}this.#selectError&&(_=this.#selectError,h=this.#selectResult,v=Date.now(),y=`error`);let S=f.fetchStatus===`fetching`,T=y===`pending`,E=y===`error`,D=T&&S,O=h!==void 0,k={status:y,fetchStatus:f.fetchStatus,isPending:T,isSuccess:y===`success`,isError:E,isInitialLoading:D,isLoading:D,data:h,dataUpdatedAt:f.dataUpdatedAt,error:_,errorUpdatedAt:v,failureCount:f.fetchFailureCount,failureReason:f.fetchFailureReason,errorUpdateCount:f.errorUpdateCount,isFetched:f.dataUpdateCount>0||f.errorUpdateCount>0,isFetchedAfterMount:f.dataUpdateCount>u.dataUpdateCount||f.errorUpdateCount>u.errorUpdateCount,isFetching:S,isRefetching:S&&!T,isLoadingError:E&&!O,isPaused:f.fetchStatus===`paused`,isPlaceholderData:p,isRefetchError:E&&O,isStale:w(e,t),refetch:this.refetch,promise:this.#currentThenable,isEnabled:r(t.enabled,e)!==!1},A=k;if(this.options.experimental_prefetchInRender){let t=e=>{A.status===`error`?e.reject(A.error):A.data!==void 0&&e.resolve(A.data)},n=()=>{let e=this.#currentThenable=A.promise=g();t(e)},r=this.#currentThenable;switch(r.status){case`pending`:e.queryHash===i.queryHash&&t(r);break;case`fulfilled`:(A.status===`error`||A.data!==r.value)&&n();break;case`rejected`:(A.status!==`error`||A.error!==r.reason)&&n();break}}return A}updateResult(){let e=this.#currentResult,t=this.createResult(this.#currentQuery,this.options);if(this.#currentResultState=this.#currentQuery.state,this.#currentResultOptions=this.options,this.#currentResultState.data!==void 0&&(this.#lastQueryWithDefinedData=this.#currentQuery),a(t,e))return;this.#currentResult=t;let n=()=>{if(!e)return!0;let{notifyOnChangeProps:t}=this.options,n=typeof t==`function`?t():t;if(n===`all`||!n&&!this.#trackedProps.size)return!0;let r=new Set(n??this.#trackedProps);return this.options.throwOnError&&r.add(`error`),Object.keys(this.#currentResult).some(t=>{let n=t,i=this.#currentResult[n]!==e[n];return i&&r.has(n)})};this.#notify({listeners:n()})}#updateQuery(){let e=this.#client.getQueryCache().build(this.#client,this.options);if(e===this.#currentQuery)return;let t=this.#currentQuery;this.#currentQuery=e,this.#currentQueryInitialState=e.state,this.hasListeners()&&(t?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#updateTimers()}#notify(e){h.batch(()=>{e.listeners&&this.listeners.forEach(e=>{e(this.#currentResult)}),this.#client.getQueryCache().notify({query:this.#currentQuery,type:`observerResultsUpdated`})})}};function b(e,t){return r(t.enabled,e)!==!1&&e.state.data===void 0&&!(e.state.status===`error`&&t.retryOnMount===!1)}function x(e,t){return b(e,t)||e.state.data!==void 0&&S(e,t,t.refetchOnMount)}function S(e,t,n){if(r(t.enabled,e)!==!1&&i(t.staleTime,e)!==`static`){let r=typeof n==`function`?n(e):n;return r===`always`||r!==!1&&w(e,t)}return!1}function C(e,t,n,i){return(e!==t||r(i.enabled,e)===!1)&&(!n.suspense||e.state.status!==`error`)&&w(e,n)}function w(e,t){return r(t.enabled,e)!==!1&&e.isStaleByTime(i(t.staleTime,e))}function T(e,t){return!a(e.getCurrentResult(),t)}var E=d(u()),D=E.createContext(!1),O=()=>E.useContext(D);D.Provider,p();function k(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}var A=E.createContext(k()),j=()=>E.useContext(A),M=(e,t)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&(t.isReset()||(e.retryOnMount=!1))},N=e=>{E.useEffect(()=>{e.clearReset()},[e])},P=({result:e,errorResetBoundary:t,throwOnError:n,query:r,suspense:i})=>e.isError&&!t.isReset()&&!e.isFetching&&r&&(i&&e.data===void 0||o(n,[e.error,r])),F=e=>{if(e.suspense){let t=1e3,n=e=>e===`static`?e:Math.max(e??t,t),r=e.staleTime;e.staleTime=typeof r==`function`?(...e)=>n(r(...e)):n(r),typeof e.gcTime==`number`&&(e.gcTime=Math.max(e.gcTime,t))}},I=(e,t)=>e.isLoading&&e.isFetching&&!t,L=(e,t)=>e?.suspense&&t.isPending,R=(e,t,n)=>t.fetchOptimistic(e).catch(()=>{n.clearReset()});function z(e,n,r){let i=O(),a=j(),o=f(r),s=o.defaultQueryOptions(e);o.getDefaultOptions().queries?._experimental_beforeQuery?.(s),s._optimisticResults=i?`isRestoring`:`optimistic`,F(s),M(s,a),N(a);let c=!o.getQueryCache().get(s.queryHash),[l]=E.useState(()=>new n(o,s)),u=l.getOptimisticResult(s),d=!i&&e.subscribed!==!1;if(E.useSyncExternalStore(E.useCallback(e=>{let n=d?l.subscribe(h.batchCalls(e)):t;return l.updateResult(),n},[l,d]),()=>l.getCurrentResult(),()=>l.getCurrentResult()),E.useEffect(()=>{l.setOptions(s)},[s,l]),L(s,u))throw R(s,l,a);if(P({result:u,errorResetBoundary:a,throwOnError:s.throwOnError,query:o.getQueryCache().get(s.queryHash),suspense:s.suspense}))throw u.error;if(o.getDefaultOptions().queries?._experimental_afterQuery?.(s,u),s.experimental_prefetchInRender&&!v&&I(u,i)){let e=c?R(s,l,a):o.getQueryCache().get(s.queryHash)?.promise;e?.catch(t).finally(()=>{l.updateResult()})}return s.notifyOnChangeProps?u:l.trackResult(u)}function B(e,t){return z(e,y,t)}export{B as b};