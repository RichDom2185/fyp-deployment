import{n as e,t}from"./hooks-BAT23hyk.js";import{K as n,T as r,Z as i,n as a,t as o,w as s,x as c}from"./index-Ra2lGJdp.js";import{t as l}from"./button-ZbUugITV.js";import{t as u}from"./pencil-BtoSBbQo.js";import{t as d}from"./plus-DHQX-CAp.js";import{t as f}from"./trash-2-tH3XFeSR.js";import{t as p}from"./input-DWGpcTdi.js";import"./es2015-B0iSd3k2.js";import{a as m,i as h,o as g,r as _,s as v,t as y}from"./dialog-ZgoMsabM.js";import{i as b,n as x,t as S}from"./tooltip-Dk6vBk5_.js";import"./shim-D_jmsJEB.js";import{n as C,r as w,t as T}from"./avatar-aNmJ1UI2.js";import{t as E}from"./label-qYupBdTo.js";import{a as D,n as O,o as k,r as A,t as j}from"./card-DzwWgtAJ.js";import{a as M,i as N,n as P,o as F,r as I,t as L}from"./table-BsLSmiLX.js";import{t as R}from"./checkbox-DX-wiV40.js";import{n as z,r as B,t as V}from"./popover-zjDvaFk7.js";var H=i(n()),U=i(r()),W=e=>{let t=e.split(`_`);return t.length>1?t.slice(1).join(` `):e},G=e=>e.charAt(0)+e.slice(1).toLowerCase(),K=e=>e.reduce((e,t)=>{let n=t.name.split(`_`)[0]||`OTHER`;return e[n]||(e[n]=[]),e[n].push(t),e},{});function q({permissions:e,selectedPermissions:t,onPermissionChange:n}){let r=e=>{t.includes(e)?n(t.filter(t=>t!==e)):n([...t,e])};return(0,U.jsx)(`div`,{className:`border rounded-lg`,children:(0,U.jsx)(`div`,{className:`grid grid-cols-1 gap-4 p-4`,children:Object.entries(K(e)).map(([e,n])=>(0,U.jsxs)(`div`,{className:`space-y-2`,children:[(0,U.jsx)(`h4`,{className:`font-medium text-sm`,children:G(e)}),(0,U.jsx)(`div`,{className:`grid grid-cols-2 md:grid-cols-3 gap-3`,children:n.map(e=>(0,U.jsxs)(`div`,{className:`flex items-center space-x-2`,children:[(0,U.jsx)(R,{id:`permission-${e.id}`,checked:t.includes(e.id),onCheckedChange:()=>r(e.id)}),(0,U.jsx)(E,{htmlFor:`permission-${e.id}`,className:`text-sm font-normal cursor-pointer`,children:W(e.name)})]},e.id))})]},e))})})}var J=q;function Y({open:e,onOpenChange:t,onConfirm:n,permissions:r,dialogTitle:i,dialogDescription:a,inputId:o,submitButtonText:s,loadingText:c,initialRoleName:u,initialSelectedPermissions:d}){let[f,b]=(0,H.useState)(!1),[x,S]=(0,H.useState)(u||``),[C,w]=(0,H.useState)(d||[]);return(0,U.jsx)(y,{open:e,onOpenChange:t,children:(0,U.jsxs)(_,{className:`max-w-3xl max-h-[80vh] overflow-y-auto`,children:[(0,U.jsxs)(g,{children:[(0,U.jsx)(v,{children:i}),(0,U.jsx)(h,{children:a})]}),(0,U.jsxs)(`div`,{className:`space-y-4`,children:[(0,U.jsxs)(`div`,{className:`space-y-2`,children:[(0,U.jsx)(E,{htmlFor:o,children:`Role Name`}),(0,U.jsx)(p,{id:o,value:x,onChange:e=>S(e.target.value),placeholder:`Enter role name`})]}),(0,U.jsxs)(`div`,{className:`space-y-2`,children:[(0,U.jsx)(E,{children:`Permissions`}),(0,U.jsx)(J,{permissions:r,selectedPermissions:C,onPermissionChange:w})]})]}),(0,U.jsxs)(m,{children:[(0,U.jsx)(l,{variant:`outline`,onClick:()=>{t(!1),S(``),w([])},children:`Cancel`}),(0,U.jsx)(l,{onClick:async()=>{b(!0);try{await n(x,C),S(``),w([])}catch(e){console.error(`Error creating role:`,e),window.alert(`Failed to create role. Please try again.`)}finally{b(!1)}},disabled:f||!x.trim()||C.length===0,children:f?(0,U.jsxs)(U.Fragment,{children:[c,`…`]}):s})]})]})})}var X=Y;function Z({open:e,onOpenChange:t,onCreate:n,permissions:r}){return(0,U.jsx)(X,{open:e,onOpenChange:t,onConfirm:n,permissions:r,dialogTitle:`Create New Role`,dialogDescription:`Create a custom role with at least 1 permission.`,inputId:`role-name`,submitButtonText:`Create Role`,loadingText:`Creating`})}var Q=Z;function $({open:e,onOpenChange:t,onUpdate:n,permissions:r,roleDetails:i}){return(0,U.jsx)(X,{open:e,onOpenChange:t,onConfirm:n,permissions:r,dialogTitle:`Edit Role`,dialogDescription:`Select at least 1 permission for this role.`,inputId:`edit-role-name`,submitButtonText:`Save Changes`,loadingText:`Saving`,initialRoleName:i.name,initialSelectedPermissions:i.permissions.map(e=>e.id)})}var ee=$;function te({members:e,maxDisplay:t=3}){if(e.length===0)return(0,U.jsx)(`span`,{className:`text-muted-foreground`,children:`No members`});let n=e.slice(0,t),r=e.length-t;return(0,U.jsx)(`div`,{className:`flex items-center gap-2`,children:(0,U.jsxs)(V,{children:[(0,U.jsx)(B,{children:(0,U.jsxs)(`div`,{className:`flex -space-x-2 cursor-pointer hover:opacity-80 transition-opacity`,children:[n.map(e=>(0,U.jsxs)(T,{className:`h-8 w-8 border-2 border-background`,children:[(0,U.jsx)(w,{src:e.avatarUrl??void 0,alt:e.fullName}),(0,U.jsx)(C,{className:`text-xs`,children:e.fullName.charAt(0).toUpperCase()})]},e.userId)),r>0&&(0,U.jsxs)(`div`,{className:`h-8 w-8 rounded-full border-2 border-background bg-muted flex items-center justify-center text-xs font-medium`,children:[`+`,r]})]})}),(0,U.jsx)(z,{className:`w-72`,children:(0,U.jsxs)(`div`,{className:`space-y-2`,children:[(0,U.jsxs)(`h4`,{className:`font-semibold text-sm`,children:[`Members (`,e.length,`)`]}),(0,U.jsx)(`div`,{className:`max-h-60 overflow-y-auto space-y-2`,children:e.map(e=>(0,U.jsxs)(`div`,{className:`flex items-center gap-2 p-2 rounded hover:bg-muted`,children:[(0,U.jsxs)(T,{className:`h-8 w-8`,children:[(0,U.jsx)(w,{src:e.avatarUrl??void 0,alt:e.fullName}),(0,U.jsx)(C,{className:`text-xs`,children:e.fullName.charAt(0).toUpperCase()})]}),(0,U.jsxs)(`div`,{className:`flex-1 min-w-0`,children:[(0,U.jsx)(`div`,{className:`text-sm font-medium truncate`,children:e.fullName}),(0,U.jsx)(`div`,{className:`text-xs text-muted-foreground truncate`,children:e.email})]})]},e.userId))})]})})]})})}var ne=te;function re({roles:e,handleEditRole:t,handleDeleteRole:n,isEditDisabled:r,isDeleteDisabled:i}){return(0,U.jsxs)(L,{children:[(0,U.jsx)(M,{children:(0,U.jsxs)(F,{children:[(0,U.jsx)(N,{children:`Role Name`}),(0,U.jsx)(N,{children:`Permissions`}),(0,U.jsx)(N,{children:`Members`}),(0,U.jsx)(N,{className:`text-right`,children:`Actions`})]})}),(0,U.jsx)(P,{children:e.map(e=>(0,U.jsxs)(F,{children:[(0,U.jsx)(I,{className:`font-medium`,children:e.name}),(0,U.jsx)(I,{children:e.permissionCount}),(0,U.jsx)(I,{children:(0,U.jsx)(ne,{members:e.members})}),(0,U.jsx)(I,{className:`text-right`,children:(0,U.jsxs)(`div`,{className:`flex justify-end`,children:[!r(e)&&(0,U.jsxs)(S,{children:[(0,U.jsx)(b,{children:(0,U.jsx)(l,{variant:`ghost`,size:`icon`,onClick:()=>t(e),children:(0,U.jsx)(u,{})})}),(0,U.jsx)(x,{children:`Edit Role`})]}),(0,U.jsxs)(S,{children:[(0,U.jsx)(b,{children:(0,U.jsx)(l,{className:`text-destructive`,variant:`ghost`,size:`icon`,onClick:()=>n(e),disabled:i(e),children:(0,U.jsx)(f,{})})}),(0,U.jsx)(x,{children:i(e)?`Cannot delete role with members or default role`:`Delete Role`})]})]})})]},e.id))})]})}var ie=re;const ae={breadcrumb:`Role Settings`};function oe(){let{courseId:n}=c(),r=n?parseInt(n):null,i=s(),[u,f]=(0,H.useState)(!1),[p,b]=(0,H.useState)(!1),[x,S]=(0,H.useState)(!1),[C,w]=(0,H.useState)(null),{data:T,isLoading:E}=t({...o.roles.list(r),errorMessage:`Failed to load roles`,fallbackValue:[],enabled:!!r}),{data:M}=t({...o.roles.permissions(r),errorMessage:`Failed to load permissions`,fallbackValue:[],enabled:!!r}),{data:N}=t({...o.roles.detail(r,C),errorMessage:`Failed to load role details`,enabled:!!r&&!!C&&p}),P=()=>{i.invalidateQueries({queryKey:o.roles.list._def})},F=e({mutationFn:async e=>{let t=await a.POST(`/api/v1/courses/{courseId}/roles`,{params:{path:{courseId:parseInt(n)}},body:e});if(t.error)throw Error(`Failed to create role`);return t.data},errorMessage:`Failed to create role`,showSuccessToast:!0,successMessage:`Role created successfully`,onSuccess:()=>{P(),f(!1)}}),I=e({mutationFn:async({roleId:e,data:t})=>{let r=await a.PUT(`/api/v1/courses/{courseId}/roles/{roleId}`,{params:{path:{courseId:parseInt(n),roleId:e}},body:t});if(r.error)throw Error(`Failed to update role`);return r.data},errorMessage:`Failed to update role`,showSuccessToast:!0,successMessage:`Role updated successfully`,onSuccess:()=>{P(),b(!1),w(null)}}),L=e({mutationFn:async e=>{let t=await a.DELETE(`/api/v1/courses/{courseId}/roles/{roleId}`,{params:{path:{courseId:parseInt(n),roleId:e}}});if(t.error)throw Error(`Failed to delete role`);return t.data},errorMessage:`Failed to delete role`,showSuccessToast:!0,successMessage:`Role deleted successfully`,onSuccess:()=>{P(),S(!1),w(null)}}),R=async(e,t)=>{e.trim()&&await F.mutateAsync({name:e,permissionIds:t})},z=async(e,t)=>{!C||!e.trim()||await I.mutateAsync({roleId:C,data:{name:e,permissionIds:t}})},B=()=>{C&&L.mutate(C)},V=T?.find(e=>e.id===C),W=e=>[`admin`,`instructor`,`student`].includes(e.toLowerCase());return(0,U.jsxs)(`div`,{className:`space-y-6 px-12 py-10`,children:[(0,U.jsxs)(`div`,{className:`flex items-center justify-between`,children:[(0,U.jsxs)(`div`,{children:[(0,U.jsx)(`h1`,{className:`text-3xl font-bold`,children:`Roles & Permissions`}),(0,U.jsx)(`p`,{className:`text-muted-foreground`,children:`Manage roles and their permissions for this course`})]}),(0,U.jsxs)(l,{onClick:()=>f(!0),children:[(0,U.jsx)(d,{className:`h-4 w-4`}),`Create Role`]})]}),(0,U.jsxs)(j,{children:[(0,U.jsxs)(D,{children:[(0,U.jsx)(k,{children:`Course Roles`}),(0,U.jsx)(A,{children:`View and manage all roles in this course. Default roles (Admin, Instructor, Student) cannot be edited or deleted.`})]}),(0,U.jsx)(O,{children:E?(0,U.jsx)(`div`,{className:`text-center py-8`,children:`Loading roles...`}):!T||T.length===0?(0,U.jsx)(`div`,{className:`text-center py-8 text-muted-foreground`,children:`No roles found`}):(0,U.jsx)(ie,{roles:T,handleEditRole:e=>{w(e.id),b(!0)},handleDeleteRole:e=>{w(e.id),S(!0)},isEditDisabled:e=>W(e.name),isDeleteDisabled:e=>W(e.name)||e.memberCount>0})})]}),(0,U.jsx)(Q,{open:u,onOpenChange:f,onCreate:R,permissions:M??[]}),N&&(0,U.jsx)(ee,{open:p,onOpenChange:e=>{b(e),e||w(null)},onUpdate:z,permissions:M??[],roleDetails:N}),(0,U.jsx)(y,{open:x,onOpenChange:S,children:(0,U.jsxs)(_,{children:[(0,U.jsxs)(g,{children:[(0,U.jsx)(v,{children:`Delete Role`}),(0,U.jsxs)(h,{children:[`Are you sure you want to delete the role “`,V?.name,`”? This action cannot be undone.`]})]}),(0,U.jsxs)(m,{children:[(0,U.jsx)(l,{variant:`outline`,onClick:()=>{S(!1),w(null)},children:`Cancel`}),(0,U.jsx)(l,{variant:`destructive`,onClick:B,disabled:L.isPending,children:L.isPending?`Deleting...`:`Delete`})]})]})})]})}const se=oe;export{se as Component,ae as handle};